"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js");if(!Array){(e.resolveComponent("dtPicker")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../components/dtPicker/dtPicker.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const t={__name:"index",setup(t){e.onLoad((e=>{console.log(e),y(e)}));const o=getApp(),i=e.ref(),n=e.ref(),s=e.ref({}),l=e.ref([]),d=e.ref(0),r=e.reactive({price:"",starttime:"",address:{userName:"",cityName:"",countyName:"",detailInfo:""},receiveAddress:"",tel:"",demand:""}),c=e.reactive({page_xy:"",page_fw:""}),u=e.reactive({name:""}),v=e.ref(!1),p=e.reactive({phone:"",validCode:""}),m=e.reactive({validText:"获取验证码",time:60}),y=a=>{o.globalData.utils.request({url:"/Service/order",data:{svid:a.svid},success:t=>{console.log(t,"/Service/order"),s.value=t.data.data.service,l.value=t.data.data.hospitals;const o=e.toRaw(l.value);if(a.hid>0)for(let e=0;e<o.length;e++)if(o[e].id==a.hid){d.value=e,r.price=o[e].service_price;break}}})},x=()=>{},g=a=>{const t=parseInt(a.detail.value);d.value=t,r.price=e.toRaw(l.value)[t].service_price},h=e=>{r.starttime=e.detail.value},f=()=>{e.index.navigateTo({url:"../clients/index?act=select"})};e.index.$on("clientChange",(e=>{console.log(e,"data"),u.name=e.name,u.id=e.user_id,u.sex=e.sex,u.age=e.age,u.mobile=e.mobile}));const _=()=>{v.value=!v.value},w=()=>{e.index.chooseAddress({success:e=>{console.log(e,"adress"),r.address.userName=e.userName,r.address.cityName=e.cityName,r.address.countyName=e.countyName,r.address.detailInfo=e.detailInfo}})};let T;const b=()=>{if(!v.value)return e.index.showToast({title:"请先阅读并同意用户协议和服务协议",icon:"none",duration:1e3});const a=e.toRaw(r),t=e.toRaw(s.value),o=e.toRaw(l.value),n=e.toRaw(u);if(a.service_code=t.id.code,a.service_id=t.id,a.service_name=t.name,a.service_stype=t.stype,t.stype<100){if(0==d.value)return e.index.showToast({title:"请选择医院",icon:"none",duration:1e3});a.hospital_id=o[d.value].id,a.hospital_name=o[d.value].name}if(!a.starttime)return e.index.showToast({title:"请选择时间",icon:"none",duration:1e3});if(10==t.stype||15==t.stype||20==t.stype){if(!n.id)return e.index.showToast({title:"请选择就诊人",icon:"none",duration:1e3});if(a.client={},a.client.age=n.age,a.client.mobile=n.mobile,a.client.name=n.name,a.client.sex=n.sex,15==t.stype&&!a.receiveAddress)return e.index.showToast({title:"请填写就诊人所在地址",icon:"none",duration:1e3})}return 30!=t.stype&&40!=t.stype||a.address.userName?a.tel?(T=a,void(e.index.getStorageSync("token")?q(T):i.value.open("center"))):e.index.showToast({title:"请填写您的联系方式",icon:"none",duration:1e3}):e.index.showToast({title:"请选择收件地址",icon:"none",duration:1e3})},k=()=>{i.value.close()},N=()=>{if(!p.phone||!p.validCode)return e.index.showToast({title:"请输入手机号和验证码",icon:"none",duration:1e3});o.globalData.utils.request({url:"/user/authentication",method:"POST",data:{tel:p.phone,code:p.validCode},success:a=>{e.index.setStorageSync("token",a.data.data.token),q(T)},fail:a=>{e.index.showToast({title:a.msg,icon:"none",duration:1e3})}})};let C=!1;const S=()=>{if(!p.phone)return e.index.showToast({title:"请输入手机号",icon:"none",duration:1e3});if(C)return;const a=setInterval((()=>{m.time<=0?(m.validText="获取验证码",m.time=60,C=!1,clearInterval(a)):(m.time-=1,m.validText=`剩余${m.time}s`)}),1e3);C=!0,o.globalData.utils.request({url:"/get/code",method:"POST",data:{tel:p.phone},success:a=>{e.index.showToast({title:"验证码发送成功，请尽快验证",icon:"none",duration:1e3})},fail:a=>{e.index.showToast({title:a.msg,icon:"none",duration:1e3})}})},q=a=>{console.log(a,"创建订单"),o.globalData.utils.request({url:"/pay/createOrder",method:"POST",header:{token:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a,"chuangjian "),n.value.open("center");const t=new e.UQRCode;t.data=a.data.wx_code,t.size=150,t.make();var o=e.index.createCanvasContext("qrcode");t.canvasContext=o,t.drawCanvas()},fail:e=>{}})},P=()=>{e.index.switchTab({url:"../order/index"})};return(t,o)=>e.e({a:a._imports_0$4,b:s.value.icon_image?s.value.icon_image_url:"../../static/images/avatar.jpg",c:e.t(s.value.name),d:e.o(x),e:10==s.value.stype||15==s.value.stype||20==s.value.stype},10==s.value.stype||15==s.value.stype||20==s.value.stype?e.e({f:l.value[d.value].name,g:e.o(g),h:d.value,i:l.value,j:e.o(h),k:e.p({timestamp:r.starttime,placeholder:"请选择就诊时间"}),l:u.name,m:e.o(f),n:15==s.value.stype},15==s.value.stype?{o:r.receiveAddress,p:e.o((e=>r.receiveAddress=e.detail.value))}:{},{q:r.tel,r:e.o((e=>r.tel=e.detail.value))}):{},{s:30==s.value.stype||40==s.value.stype},30==s.value.stype||40==s.value.stype?{t:l.value[d.value].name,v:e.o(g),w:d.value,x:l.value,y:e.o(h),z:e.p({timestamp:r.starttime,placeholder:"请选择期望服务时间"}),A:r.address.userName?r.address.userName+"("+r.address.cityName+r.address.countyName+r.address.detailInfo+")":"",B:e.o(w),C:r.tel,D:e.o((e=>r.tel=e.detail.value))}:{},{E:r.demand,F:e.o((e=>r.demand=e.detail.value)),G:e.n("is_xieyi "+(v.value?"is_xieyi_on":"")),H:e.o(_),I:c.page_xy,J:c.page_fw,K:r.price>0},r.price>0?{L:e.t(r.price)}:{},{M:e.n("btnp "+(v.value?"":"btnp-disabled")),N:e.o(b),O:p.phone,P:e.o((e=>p.phone=e.detail.value)),Q:p.validCode,R:e.o((e=>p.validCode=e.detail.value)),S:e.t(m.validText),T:e.o(S),U:e.o(k),V:e.o(N),W:e.sr(i,"2b9dc80c-2",{k:"popup"}),X:e.p({type:"center","is-mask-click":!1,"background-color":"#fff"}),Y:e.o(P),Z:a._imports_0$1,aa:e.sr(n,"2b9dc80c-3",{k:"qrcodePopup"}),ab:e.p({type:"center","is-mask-click":!1,"background-color":"#fff"})})}};wx.createPage(t);
